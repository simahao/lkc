# 进程与线程管理设计文档

## 进程和线程的状态

### 进程状态
进程作为资源管理的单位，具有以下三种状态：

- **PCB_UNUSED**：进程未使用。
- **PCB_USED**：进程正在使用中。
- **PCB_ZOMBIE**：进程的线程已全部退出，等待父进程回收。

状态转移图如下：

![进程状态转移图](thread_and_proc.assets/image-20230819202900306.png)

进程的状态转换包括两个步骤：原子性地设置状态字段和切换队列。

### 线程状态
线程作为调度的单位，具有以下五种状态：

- **TCB_UNUSED**：线程未使用。
- **TCB_USED**：线程正在使用中。
- **TCB_RUNNING**：线程正在运行。
- **TCB_RUNNABLE**：线程可运行。
- **TCB_SLEEPING**：线程正在休眠。

状态转移图如下：

![线程状态转移图](thread_and_proc.assets/image-20230819202926508.png)

线程状态转换同样包括两个步骤：原子性地设置状态字段和切换队列。

## 进程和线程之间的关系

### 进程关系
进程间的关系是分层的，形成树状结构。每个进程都有一个父进程，并且可以有多个子进程。进程需要维护这种父子关系，并且在子进程退出时，由父进程负责回收资源。

### 线程关系
线程间的关系是扁平的，不存在父子关系。线程的资源回收不需要其他线程协助。

### 进程与线程的关系
每个进程都有一个线程组，其中包含一个或多个线程。线程组中的第一个线程被称为主线程。进程的资源管理通过线程组进行，而线程则负责具体的执行流。

## 进程的生命周期

### 进程家族树
进程通过多叉树结构维护家族关系，每个进程都有一个父进程，并且可以有多个子进程。

### 进程资源管理
进程的资源包括页表、文件打开表、信号处理队列等。进程的资源在进程退出时由父进程回收。

### 进程状态转换
进程的状态转换涉及状态字段的设置和队列的切换，通过`PCB_Q_changeState`函数实现。

## 线程的生命周期

### 线程初始化
线程通过全局数组进行管理，每个线程有一个唯一的线程ID（tid）。

### 线程资源管理
线程的资源包括内核栈、用户栈、信号处理队列等。线程的资源在线程退出时自行回收。

### 线程状态转换
线程的状态转换涉及状态字段的设置和队列的切换，通过`TCB_Q_changeState`函数实现。

## 内核级线程调度

### 调度器
内核级线程调度确保线程可以在多个CPU核心上运行。调度器负责将可运行状态的线程分配到各个CPU上执行。

### 线程同步
内核提供同步原语，如条件变量、信号量等，用于线程间的同步。

## 进程与线程的设计哲学

### 资源管理
进程作为资源管理的单位，线程作为执行流的单位。线程设计为最小的调度单位，而进程则负责管理一组线程的资源。

### 多核支持
操作系统设计支持多核多线程，允许一个进程的多个线程在多个CPU核心上并行执行。

### 扁平与树状结构
线程采用扁平结构管理，进程采用树状结构管理，以适应不同的管理需求。

## 理想操作系统设计

### 多执行流
操作系统应支持多个执行流在不同CPU核心上切换。

### 资源共享
线程应拥有私有的内核栈和用户栈，而与其他线程共享如页表和文件打开表等资源。

### 真正的多线程
操作系统应允许一个进程的多个线程在多个CPU核心上真正并发运行。

通过上述设计，操作系统能够高效地管理进程和线程，提供灵活的调度策略，并优化资源的使用。